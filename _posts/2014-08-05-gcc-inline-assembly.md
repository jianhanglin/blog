---
layout: post
title: GCC内联汇编
category: osdev
tags:
- inline assembly
- gcc
- osdev
---
编写底层代码，有些事情必须通过汇编语言才能完成，内联汇编就是在C/C++
代码中嵌入汇编语言程序。编写汇编语言函数例程并在C/C++中调用也是一种办法，但是内敛的方式甚至省去了函数调用的负担。

内联汇编是与编译器高度相关的，以下所述仅适用于GCC及其兼容编译器（ICC、Clang）。

### 语法

内联汇编的语法如下：

~~~ {.c}
asm ( 汇编语言代码
    : 输出参数列表     // 可省
    : 输入参数列表     // 可省
    : 变更寄存器列表   // 可省
);
~~~

首先是一个`asm`关键字（C99环境中asm不是关键字，需使用`-std=gnu99`，或将`asm`换成`__asm__`），其次是汇编语言代码，这是一个包含了汇编代码的字符串，默认使用ATT格式，但是寄存器的前缀`%`要换成`%%`，例如：

~~~ {.c}
asm ("movl %%eax, %%ebx");
~~~

内联汇编的强大之处在于可以利用C/C++代码中的变量，例如下面的代码，实现了从`a`到`b`的赋值：

~~~ {.c}
int a = 10, b;
asm ("movl %1, %%eax;
      movl %%eax, %0;"
    :"=r"(b)    // 输出
    :"r"(a)     // 输入
    :"%eax"     // 变更的寄存器
);
~~~

汇编代码中的`%0`引用第一个参数，`%1`引用第二个参数。

### 参数

上面例子中，指定了`a`为输入参数，`b`为输出参数，`eax`为改变的寄存器。指定输入输出参数时，字符串中的字母常量表示该参数存放在何处（约束），常见取值有：

| 约束 | 含义 |
|:----:|:----:|
| `g` | 任意位置 |
| `r` | 寄存器 |
| `N` | 常数 |
| `a` | eax寄存器 |

输出参数若包含等号，则说明该参数是只写的，如果参数既是输入又是输出，则应该在输出参数列表中指定，并且不包含等号。

