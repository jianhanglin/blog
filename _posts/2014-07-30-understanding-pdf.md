---
layout: post
title: 理解PDF
---
PDF（Portable Document Format）是一种神奇的文档格式，能够在不同分辨率下呈现出一致的显示效果。实际上，PDF是一种编程语言，一个PDF文件就是一份PDF语言程序，一个PDF Viewer都是一个PDF语言的解释器。

如果使用文本编辑器打开一个PDF文件

### 版本

PDF最初由Adobe公司发明，后来倍ISO组织认可为标准，在版本号规定上存在一些差异。本文主要参考了PDF1.7版本的规范。

### PDF Syntax

PDF语法可以理解为4个部分：

- 对象（Object）
- 文件结构（File structure）
- 文档结构（Document structure）
- 内容流（Content stream）

PDF文件内容就是一串字节流，这些字节可以划分为若干词素（token），就像词法分析一样。一个或多个词素共同构成更高级的语法实体，通常是对象，而对象又是PDF文件数据的主要类型。

### 字符集

PDF可以包含ASCII的全部字符，但不限于此。PDF是一个二进制文件类型，因此甚至可以包含二进制文件。

PDF支持的字符集可以分为三类：

- 空白，包括NULL（0x00）、水平制表符（0x09）、Line Feed（0x0A）、Form Feed（0x0C）、回车（0x0D）、空格（0x20）
    - 其中Line Feed（\LF）与回车（\CR）都可以用来换行，三种换行方式在PDF中都支持。
- 终止符：`(`、`)`、`[`、`]`、`{`、`}`、`<`、`>`、`/`、`%`。
- 普通字符，即不属于以上两类的全部字符。

#### 注释

PDF中可以有注释（不是annotation），注释以`%`开头（但是百分号在字符串中的不属于这种情况）。

但是有一些内容并不是注释，比如`%PDF-1.7`、`%%EOF`，这些是有特定语义的词素。

#### 对象

PDF中的对象有8种类型：

- 布尔值：只有两种，`true`和`false`
- 整数：`(+|-)?[0-9]+`
- 实数（浮点数）：十进制，包含小数点
- 字符串：字符串不用双引号，而用小括号（`(`、`)`）或者尖括号（`<`、`>`）括起，区别在于小括号里面的是字面值，尖括号里面的是十六进制描述的字符串。小括号中甚至也可以包含小括号，只要括号开闭是平衡的即可。当然PDF的字符串也支持转义：

|Literal|Escaped|
|:-----:|:-----:|
|`\n`| LF |
|`\r`| 回车 |
|`\t`| 制表符|
|`\b`| 退格符 |
|`\f`|Form Feed |
|`\(`| 左括号 |
|`\)`| 右括号 |
|`\\`| 反斜杠 |
|`\ddd`| 后跟三位8进制数 |

单独的反斜杠后跟回车可以将字符串折行。十六进制字符串只能包含ASCII中0-9以及A-F（大小写均可）的字符，非常适合嵌入图片等二进制文件，每两个相邻的字符共同组成一个字节，但最后一个字符省略，则默认为0。

- 名称（Name）：名称用来标记其他对象，名称通过斜杠`/`开始，可以包含任何字符（出了NULL），要包含特殊字符，需使用转义（以`#`开头，后跟两位十六进制数字）
- 数组：以`[`开头，以`]`结束，包含若干对象，空格隔开
- 字典：以`<<`开始，以`>>`结束，由若干键值对组成，键值对之间用换行符分隔，键和值用空格分开（键必须是名称，值可以使任意对象）
- 流
- NULL对象

对象可以加上标记（Label），这样其他对象也可以引用这个对象

### 文件结构

PDF文件有四部分组成

- 一行的版本说明，如`%PDF-1.7`
- 主体部分，包含对象的定义
- 交叉引用表，描述简介对象
- 尾部，指明交叉引用表的位置
